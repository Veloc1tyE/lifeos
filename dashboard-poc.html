<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard POC - Schema-Driven Architecture</title>
  <style>
    :root{
      --bg:#0b0d10; --panel:#12161c; --text:#e8eef6; --muted:#a7b3c2;
      --line:#243041; --accent:#7dd3fc; --good:#86efac; --warn:#fde68a; --bad:#fca5a5;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color:var(--text);
      padding:20px;
    }
    .container{max-width:900px; margin:0 auto;}
    h1{font-size:24px; margin-bottom:20px;}
    .card{
      background: rgba(18,22,28,.92);
      border:1px solid rgba(36,48,65,.85);
      border-radius:var(--radius);
      padding:20px;
      margin-bottom:20px;
    }
    .section-title{
      display:flex; justify-content:space-between; align-items:center;
      margin-bottom:15px;
    }
    .badge{
      font-size:12px; padding:6px 12px; border-radius:999px;
      border:1px solid rgba(36,48,65,.9);
      background:rgba(11,13,16,.45);
      color:var(--muted);
    }
    .badge.good{border-color: rgba(134,239,172,.55); color: rgba(134,239,172,.95); background:rgba(134,239,172,.08);}
    .badge.warn{border-color: rgba(253,230,138,.55); color: rgba(253,230,138,.95); background:rgba(253,230,138,.07);}
    .badge.bad{border-color: rgba(252,165,165,.55); color: rgba(252,165,165,.95); background:rgba(252,165,165,.07);}
    .days{
      display:grid; 
      grid-template-columns: repeat(7, minmax(130px, 1fr)); 
      gap:10px;
      overflow-x:auto;
      padding-bottom:10px;
      margin:15px 0;
    }
    .day{
      border:1px solid rgba(36,48,65,.9);
      border-radius:12px;
      padding:10px;
      background:rgba(11,13,16,.55);
    }
    .day strong{display:block; font-size:11px; margin-bottom:8px; color:var(--muted)}
    .checkline{display:flex; align-items:center; gap:8px; margin:6px 0;}
    .checkline input{width:16px; height:16px;}
    label{display:block; font-size:12px; color:var(--muted); margin:10px 0 6px;}
    input[type="number"]{
      width:100%;
      padding:8px;
      border-radius:8px;
      border:1px solid rgba(36,48,65,.9);
      background:rgba(11,13,16,.65);
      color:var(--text);
    }
    .btn{
      border:1px solid rgba(36,48,65,.9);
      background:rgba(18,22,28,.9);
      color:var(--text);
      border-radius:8px;
      padding:10px 16px;
      cursor:pointer;
      margin:10px 5px 10px 0;
    }
    .btn:hover{border-color: rgba(125,211,252,.55);}
    .info{
      background:rgba(125,211,252,.08);
      border:1px solid rgba(125,211,252,.35);
      padding:12px;
      border-radius:8px;
      margin-bottom:20px;
      font-size:13px;
    }
    .states{margin:20px 0;}
    .state-item{
      padding:10px;
      border:1px solid rgba(36,48,65,.75);
      border-radius:8px;
      margin:5px 0;
      cursor:pointer;
      background:rgba(18,22,28,.75);
    }
    .state-item:hover{border-color: rgba(125,211,252,.5);}
    .state-item.active{border-color: rgba(125,211,252,.85); background:rgba(125,211,252,.10);}
  </style>
</head>
<body>
<div class="container">
  <h1>üß™ Schema-Driven Architecture POC</h1>
  
  <div class="info">
    <strong>Testing:</strong> This proof-of-concept demonstrates the new schema-driven architecture with just the Health section.
    Load your JSON data below to see it in action!
  </div>

  <div>
    <input type="file" id="fileInput" accept=".json" />
    <button class="btn" onclick="loadTestData()">Load JSON Data</button>
    <span id="status" style="margin-left:10px; color:var(--muted);"></span>
  </div>

  <div class="states" id="statesList"></div>

  <div id="editor" style="display:none;">
    <div class="card">
      <h2 id="stateTitle"></h2>
      <div id="content"></div>
    </div>
  </div>
</div>

<script>
(() => {
  "use strict";

  // ============================================
  // 1. SCHEMA CONFIGURATION
  // ============================================
  
  const DAYS = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];
  
  const SECTIONS = {
    health: {
      name: "Health & Recovery",
      emoji: "üíä",
      order: 1,
      defaultGoal: "Heal injury, rebuild capacity, protect nervous system",
      
      // Define the data structure
      defaultData: () => ({
        sleepTarget: "",
        painScale: "",
        notes: "",
        days: DAYS.map(() => ({
          rehab: false,
          aerobic: false,
          strength: false,
          sleep: false,
          meditation: false
        })),
        rhr: DAYS.map(() => "")
      }),
      
      // Define how to render the UI
      renderUI: (container, state, sectionKey) => {
        const data = state[sectionKey];
        
        container.innerHTML = `
          <div class="section-title">
            <div>
              <strong>${SECTIONS[sectionKey].emoji} ${SECTIONS[sectionKey].name}</strong>
              <div style="font-size:11px; color:var(--muted); margin-top:4px;">
                Goal: ${state.goals?.[sectionKey] || SECTIONS[sectionKey].defaultGoal}
              </div>
            </div>
            <span class="badge" id="${sectionKey}Badge">‚Äî</span>
          </div>

          <div class="days" id="${sectionKey}Days"></div>

          <div>
            <label>Resting Heart Rate Before Bed (bpm) ‚Äî Track daily</label>
            <div class="days" id="${sectionKey}RhrDays"></div>
            <div style="font-size:11px; color:var(--muted); margin-top:6px;">
              Daily RHR monitoring ‚Äî your most reliable recovery signal
            </div>
          </div>

          <div style="margin-top:15px;">
            <label>Daily RHR ‚Äî Last 12 Weeks (84 days)</label>
            <canvas id="${sectionKey}Chart" style="width:100%; height:140px; border:1px solid rgba(36,48,65,.75); border-radius:14px; background:rgba(11,13,16,.45);"></canvas>
            <div style="font-size:11px; color:var(--muted); margin-top:6px;">
              Lower is better. Watch for spikes (stress/illness) and trends (accumulated fatigue)
            </div>
          </div>

          <div style="margin-top:15px;">
            <label>Sleep target (hours)</label>
            <input type="number" id="${sectionKey}SleepTarget" value="${data.sleepTarget || ''}" step="0.5" />
          </div>

          <div style="margin-top:15px;">
            <label>Pain / limitation (0‚Äì10)</label>
            <input type="number" id="${sectionKey}PainScale" value="${data.painScale || ''}" min="0" max="10" />
          </div>
        `;
        
        // Render daily checkboxes
        renderDays(sectionKey, state);
        renderRHRDays(sectionKey, state);
        
        // Render chart
        renderRHRChart(sectionKey);
        
        // Bind inputs
        bindInputs(sectionKey, state);
        
        // Update badge
        updateBadge(sectionKey, state);
      },
      
      // Define how to score this section
      scoring: (state) => {
        const data = state.health;
        let healthScore = 0;
        const healthMax = 28; // 4 checkboxes √ó 7 days
        
        data.days.forEach(day => {
          ["rehab","aerobic","strength","sleep"].forEach(k => {
            if (day[k]) healthScore++;
          });
        });
        
        return healthScore / healthMax;
      },
      
      // Define badge computation
      badge: (score) => {
        const completed = Math.round(score * 28);
        let cls = "good";
        if (score < 0.65) cls = "warn";
        if (score < 0.35) cls = "bad";
        return { label: `${completed}/28`, cls };
      }
    }
  };

  // ============================================
  // 2. RENDERING FUNCTIONS
  // ============================================
  
  function renderDays(sectionKey, state) {
    const container = document.getElementById(`${sectionKey}Days`);
    const data = state[sectionKey];
    
    container.innerHTML = '';
    DAYS.forEach((dayName, i) => {
      const day = data.days[i] || {};
      const isSunday = i === 6;
      
      const dayDiv = document.createElement('div');
      dayDiv.className = 'day';
      dayDiv.innerHTML = `
        <strong>${dayName}</strong>
        ${isSunday ? `
          <div class="checkline">
            <input type="checkbox" data-day="${i}" data-key="meditation" ${day.meditation ? 'checked' : ''} />
            <span>Meditation</span>
          </div>
          <div class="checkline">
            <input type="checkbox" data-day="${i}" data-key="sleep" ${day.sleep ? 'checked' : ''} />
            <span>Sleep</span>
          </div>
        ` : `
          <div class="checkline">
            <input type="checkbox" data-day="${i}" data-key="meditation" ${day.meditation ? 'checked' : ''} />
            <span>Meditation</span>
          </div>
          <div class="checkline">
            <input type="checkbox" data-day="${i}" data-key="aerobic" ${day.aerobic ? 'checked' : ''} />
            <span>Aerobic</span>
          </div>
          <div class="checkline">
            <input type="checkbox" data-day="${i}" data-key="strength" ${day.strength ? 'checked' : ''} />
            <span>Strength</span>
          </div>
          <div class="checkline">
            <input type="checkbox" data-day="${i}" data-key="sleep" ${day.sleep ? 'checked' : ''} />
            <span>Sleep</span>
          </div>
        `}
      `;
      
      // Bind checkboxes
      dayDiv.querySelectorAll('input[type="checkbox"]').forEach(cb => {
        cb.addEventListener('change', () => {
          const dayIdx = parseInt(cb.dataset.day);
          const key = cb.dataset.key;
          state[sectionKey].days[dayIdx][key] = cb.checked;
          updateBadge(sectionKey, state);
        });
      });
      
      container.appendChild(dayDiv);
    });
  }
  
  function renderRHRDays(sectionKey, state) {
    const container = document.getElementById(`${sectionKey}RhrDays`);
    const data = state[sectionKey];
    
    container.innerHTML = '';
    DAYS.forEach((dayName, i) => {
      const dayDiv = document.createElement('div');
      dayDiv.className = 'day';
      dayDiv.innerHTML = `
        <strong>${dayName}</strong>
        <input type="number" 
               value="${data.rhr[i] || ''}" 
               placeholder="bpm"
               data-day="${i}"
               style="margin-top:8px;" />
      `;
      
      // Bind RHR input
      const input = dayDiv.querySelector('input');
      input.addEventListener('input', () => {
        const dayIdx = parseInt(input.dataset.day);
        state[sectionKey].rhr[dayIdx] = input.value;
      });
      
      container.appendChild(dayDiv);
    });
  }
  
  function bindInputs(sectionKey, state) {
    const sleepInput = document.getElementById(`${sectionKey}SleepTarget`);
    const painInput = document.getElementById(`${sectionKey}PainScale`);
    
    if (sleepInput) {
      sleepInput.addEventListener('input', () => {
        state[sectionKey].sleepTarget = sleepInput.value;
      });
    }
    
    if (painInput) {
      painInput.addEventListener('input', () => {
        state[sectionKey].painScale = painInput.value;
      });
    }
  }
  
  function updateBadge(sectionKey, state) {
    const section = SECTIONS[sectionKey];
    const score = section.scoring(state);
    const badge = section.badge(score);
    
    const badgeEl = document.getElementById(`${sectionKey}Badge`);
    if (badgeEl) {
      badgeEl.textContent = badge.label;
      badgeEl.className = `badge ${badge.cls}`;
    }
  }

  function renderRHRChart(sectionKey) {
    const canvas = document.getElementById(`${sectionKey}Chart`);
    if (!canvas || !db) return;
    
    requestAnimationFrame(() => {
      const ctx = canvas.getContext("2d");
      const dpr = window.devicePixelRatio || 1;
      
      const rect = canvas.getBoundingClientRect();
      const w = rect.width || 400;
      const h = 140;
      
      canvas.width = Math.floor(w * dpr);
      canvas.height = Math.floor(h * dpr);
      ctx.scale(dpr, dpr);

      // Collect last 12 weeks of daily RHR values
      const sorted = [...db.states].sort((a,b) => {
        const aw = (a.weekStart || "").trim();
        const bw = (b.weekStart || "").trim();
        if (aw && bw) return aw.localeCompare(bw);
        return a.updatedAt - b.updatedAt;
      }).slice(-12);

      // Flatten to get all daily values
      const dailyRHRs = [];
      sorted.forEach(state => {
        const rhrs = state.health?.rhr || [];
        rhrs.forEach(rhr => {
          const val = Number(rhr);
          if (val > 0 && Number.isFinite(val)) {
            dailyRHRs.push(val);
          }
        });
      });

      // Clear with dark background
      ctx.fillStyle = "rgba(11,13,16,.45)";
      ctx.fillRect(0, 0, w, h);

      if (dailyRHRs.length === 0){
        ctx.fillStyle = "rgba(167,179,194,.9)";
        ctx.font = "12px sans-serif";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText("Start tracking RHR to see daily trend", w/2, h/2);
        return;
      }

      // Calculate range
      const leftPad = 40;
      const rightPad = 12;
      const topPad = 15;
      const bottomPad = 12;
      
      const maxRHR = Math.max(...dailyRHRs);
      const minRHR = Math.min(...dailyRHRs);
      
      const minY = Math.floor((Math.max(40, minRHR - 5)) / 5) * 5;
      const maxY = Math.ceil((maxRHR + 5) / 5) * 5;
      const rangeY = maxY - minY;
      
      const chartWidth = w - leftPad - rightPad;
      const chartHeight = h - topPad - bottomPad;
      const xStep = chartWidth / Math.max(1, dailyRHRs.length - 1);

      const y = (v) => {
        if (rangeY === 0) return topPad + chartHeight / 2;
        const t = (v - minY) / rangeY;
        return topPad + chartHeight - t * chartHeight;
      };

      // Draw Y-axis
      ctx.strokeStyle = "rgba(36,48,65,.75)";
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(leftPad, topPad);
      ctx.lineTo(leftPad, topPad + chartHeight);
      ctx.stroke();

      // Draw Y-axis labels and grid lines
      ctx.fillStyle = "rgba(167,179,194,.75)";
      ctx.font = "11px monospace";
      ctx.textAlign = "right";
      ctx.textBaseline = "middle";
      
      const numTicks = Math.min(5, Math.floor(rangeY / 5) + 1);
      const tickStep = rangeY / (numTicks - 1);
      
      for (let i = 0; i < numTicks; i++) {
        const val = minY + i * tickStep;
        const yPos = y(val);
        
        ctx.fillText(Math.round(val).toString(), leftPad - 8, yPos);
        
        ctx.strokeStyle = i === 0 ? "rgba(36,48,65,.75)" : "rgba(36,48,65,.35)";
        ctx.setLineDash(i === 0 ? [] : [2, 2]);
        ctx.beginPath();
        ctx.moveTo(leftPad, yPos);
        ctx.lineTo(w - rightPad, yPos);
        ctx.stroke();
      }
      ctx.setLineDash([]);

      // Calculate average
      const avgRHR = dailyRHRs.reduce((a,b)=>a+b,0) / dailyRHRs.length;
      ctx.strokeStyle = "rgba(125,211,252,.4)";
      ctx.lineWidth = 1;
      ctx.setLineDash([4, 4]);
      ctx.beginPath();
      ctx.moveTo(leftPad, y(avgRHR));
      ctx.lineTo(w - rightPad, y(avgRHR));
      ctx.stroke();
      ctx.setLineDash([]);
      
      // Average label
      ctx.fillStyle = "rgba(125,211,252,.75)";
      ctx.font = "10px sans-serif";
      ctx.textAlign = "left";
      ctx.fillText(`avg: ${Math.round(avgRHR)}`, leftPad + 5, y(avgRHR) - 6);

      // Draw gradient
      const gradient = ctx.createLinearGradient(0, y(minY), 0, y(maxY));
      gradient.addColorStop(0, "rgba(134,239,172,.15)");
      gradient.addColorStop(0.5, "rgba(125,211,252,.08)");
      gradient.addColorStop(1, "rgba(252,165,165,.12)");
      ctx.fillStyle = gradient;
      ctx.beginPath();
      dailyRHRs.forEach((v,i) => {
        const x = leftPad + i*xStep;
        const yy = y(v);
        if (i===0) ctx.moveTo(x, yy);
        else ctx.lineTo(x, yy);
      });
      ctx.lineTo(leftPad + (dailyRHRs.length-1)*xStep, topPad + chartHeight);
      ctx.lineTo(leftPad, topPad + chartHeight);
      ctx.closePath();
      ctx.fill();

      // Draw main line
      ctx.strokeStyle = "rgba(125,211,252,.95)";
      ctx.lineWidth = 2;
      ctx.lineJoin = "round";
      ctx.lineCap = "round";
      ctx.beginPath();
      dailyRHRs.forEach((v,i) => {
        const x = leftPad + i*xStep;
        const yy = y(v);
        if (i===0) ctx.moveTo(x, yy);
        else ctx.lineTo(x, yy);
      });
      ctx.stroke();

      // Draw points
      dailyRHRs.forEach((v,i) => {
        const x = leftPad + i*xStep;
        const yy = y(v);
        const isLast = i === dailyRHRs.length - 1;
        const deviation = v - avgRHR;
        
        ctx.fillStyle = "rgba(11,13,16,.9)";
        ctx.beginPath();
        ctx.arc(x, yy, isLast ? 4.5 : 3, 0, Math.PI*2);
        ctx.fill();
        
        let color;
        if (deviation > 5) color = "rgba(252,165,165,.95)";
        else if (deviation > 2) color = "rgba(253,230,138,.95)";
        else if (deviation < -2) color = "rgba(134,239,172,.95)";
        else color = "rgba(125,211,252,.95)";
        
        ctx.fillStyle = isLast ? color : color.replace('.95', '.75');
        ctx.beginPath();
        ctx.arc(x, yy, isLast ? 3 : 2, 0, Math.PI*2);
        ctx.fill();
      });

      // Add "bpm" label
      ctx.save();
      ctx.fillStyle = "rgba(167,179,194,.6)";
      ctx.font = "10px sans-serif";
      ctx.textAlign = "center";
      ctx.translate(10, topPad + chartHeight / 2);
      ctx.rotate(-Math.PI / 2);
      ctx.fillText("bpm", 0, 0);
      ctx.restore();

      // Data point count
      ctx.fillStyle = "rgba(167,179,194,.5)";
      ctx.font = "10px mono";
      ctx.textAlign = "right";
      ctx.fillText(`${dailyRHRs.length} days`, w - rightPad - 5, h - 5);
    });
  }

  // ============================================
  // 3. DATA LOADING & STATE MANAGEMENT
  // ============================================
  
  let db = null;
  let currentStateId = null;
  
  function loadFromJSON(jsonData) {
    try {
      db = JSON.parse(jsonData);
      
      // Migration: convert old 'uta' to 'training' if needed
      db.states.forEach(state => {
        if (state.uta && !state.training) {
          state.training = state.uta;
          delete state.uta;
        }
        if (state.goals?.uta && !state.goals?.training) {
          state.goals.training = state.goals.uta;
          delete state.goals.uta;
        }
        
        // Ensure health.days has all required fields
        if (state.health?.days) {
          state.health.days = state.health.days.map(day => ({
            rehab: day.rehab || false,
            aerobic: day.aerobic || false,
            strength: day.strength || false,
            sleep: day.sleep || false,
            meditation: day.meditation || false
          }));
        }
      });
      
      document.getElementById('status').textContent = `‚úÖ Loaded ${db.states.length} states`;
      renderStatesList();
      
      // Select first state or the one specified in JSON
      if (db.selectedId) {
        selectState(db.selectedId);
      } else if (db.states.length > 0) {
        selectState(db.states[0].id);
      }
    } catch (e) {
      document.getElementById('status').textContent = `‚ùå Error: ${e.message}`;
    }
  }
  
  function renderStatesList() {
    const container = document.getElementById('statesList');
    container.innerHTML = '<h3>States</h3>';
    
    db.states.forEach(state => {
      const div = document.createElement('div');
      div.className = 'state-item';
      if (state.id === currentStateId) div.classList.add('active');
      div.innerHTML = `
        <strong>${state.title || 'Untitled'}</strong>
        <span style="font-size:11px; color:var(--muted); margin-left:10px;">
          ${state.weekStart || ''}
        </span>
      `;
      div.onclick = () => selectState(state.id);
      container.appendChild(div);
    });
  }
  
  function selectState(stateId) {
    currentStateId = stateId;
    const state = db.states.find(s => s.id === stateId);
    if (!state) return;
    
    document.getElementById('stateTitle').textContent = state.title || 'Untitled State';
    document.getElementById('editor').style.display = 'block';
    
    // Render Health section using schema
    const content = document.getElementById('content');
    SECTIONS.health.renderUI(content, state, 'health');
    
    // Update active state in list
    renderStatesList();
  }
  
  // ============================================
  // 4. FILE LOADING
  // ============================================
  
  document.getElementById('fileInput').addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = (event) => {
      loadFromJSON(event.target.result);
    };
    reader.readAsText(file);
  });
  
  window.loadTestData = () => {
    const input = document.getElementById('fileInput');
    if (input.files.length === 0) {
      alert('Please select a JSON file first');
    } else {
      input.dispatchEvent(new Event('change'));
    }
  };
})();
</script>
</body>
</html>

